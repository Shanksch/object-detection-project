<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🎯 Object Detection Studio</title>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        :root {
            --primary-color: #6366f1;
            --primary-dark: #4f46e5;
            --secondary-color: #8b5cf6;
            --accent-color: #06d6a0;
            --danger-color: #ef4444;
            --warning-color: #f59e0b;
            --success-color: #10b981;
            --dark-bg: #0f172a;
            --card-bg: #1e293b;
            --text-primary: #f8fafc;
            --text-secondary: #cbd5e1;
            --text-muted: #64748b;
            --border-color: #334155;
            --gradient: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--dark-bg);
            color: var(--text-primary);
            line-height: 1.6;
            overflow-x: hidden;
        }

        /* Animated background */
        .bg-animation {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            background: linear-gradient(45deg, #0f172a 0%, #1e293b 50%, #0f172a 100%);
        }

        .bg-animation::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grid" width="10" height="10" patternUnits="userSpaceOnUse"><path d="M 10 0 L 0 0 0 10" fill="none" stroke="%23334155" stroke-width="0.5" opacity="0.3"/></pattern></defs><rect width="100" height="100" fill="url(%23grid)"/></svg>');
            opacity: 0.5;
        }

        /* Header */
        .header {
            background: rgba(30, 41, 59, 0.9);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border-color);
            padding: 1rem 0;
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .nav {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 2rem;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 700;
            font-size: 1.25rem;
            background: var(--gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid var(--success-color);
            border-radius: 20px;
            font-size: 0.875rem;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--success-color);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Main container */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        /* Hero section */
        .hero {
            text-align: center;
            margin-bottom: 3rem;
        }

        .hero h1 {
            font-size: 3rem;
            font-weight: 700;
            background: var(--gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 1rem;
        }

        .hero p {
            font-size: 1.25rem;
            color: var(--text-secondary);
            max-width: 600px;
            margin: 0 auto;
        }

        /* Control panel */
        .control-panel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
            margin-bottom: 3rem;
        }

        .control-card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 2rem;
            transition: all 0.3s ease;
        }

        .control-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            border-color: var(--primary-color);
        }

        .control-title {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1rem;
        }

        .control-title i {
            color: var(--primary-color);
        }

        /* Upload area */
        .upload-area {
            border: 2px dashed var(--border-color);
            border-radius: 12px;
            padding: 3rem 2rem;
            text-align: center;
            background: rgba(51, 65, 85, 0.3);
            transition: all 0.3s ease;
            cursor: pointer;
            margin-bottom: 1.5rem;
        }

        .upload-area:hover {
            border-color: var(--primary-color);
            background: rgba(99, 102, 241, 0.1);
        }

        .upload-area.drag-over {
            border-color: var(--accent-color);
            background: rgba(6, 214, 160, 0.1);
            transform: scale(1.02);
        }

        .upload-icon {
            font-size: 3rem;
            color: var(--text-muted);
            margin-bottom: 1rem;
        }

        .upload-text {
            font-size: 1.125rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }

        .upload-subtext {
            font-size: 0.875rem;
            color: var(--text-muted);
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.875rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 500;
            text-decoration: none;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
        }

        .btn:before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            transition: left 0.5s;
        }

        .btn:hover:before {
            left: 100%;
        }

        .btn-primary {
            background: var(--gradient);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(99, 102, 241, 0.4);
        }

        .btn-secondary {
            background: transparent;
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            border-color: var(--primary-color);
            background: rgba(99, 102, 241, 0.1);
        }

        .btn-success {
            background: var(--success-color);
            color: white;
        }

        .btn-danger {
            background: var(--danger-color);
            color: white;
        }

        .btn-live {
            background: linear-gradient(135deg, var(--danger-color) 0%, var(--warning-color) 100%);
            color: white;
            animation: glow 2s infinite alternate;
        }

        @keyframes glow {
            from { box-shadow: 0 4px 20px rgba(239, 68, 68, 0.3); }
            to { box-shadow: 0 8px 30px rgba(239, 68, 68, 0.6); }
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        .btn-group {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
        }

        /* Status messages */
        .status-message {
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
            display: none;
            animation: slideIn 0.3s ease;
        }

        .status-success {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid var(--success-color);
            color: var(--success-color);
        }

        .status-error {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid var(--danger-color);
            color: var(--danger-color);
        }

        .status-warning {
            background: rgba(245, 158, 11, 0.1);
            border: 1px solid var(--warning-color);
            color: var(--warning-color);
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Results section */
        .results-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 2rem;
            margin-top: 3rem;
        }

        .result-card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .result-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }

        .result-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border-color);
        }

        .result-title {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .result-subtitle {
            color: var(--text-muted);
            font-size: 0.875rem;
        }

        .result-image {
            width: 100%;
            height: 300px;
            object-fit: contain;
            background: rgba(15, 23, 42, 0.8);
        }

        .result-placeholder {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 300px;
            background: rgba(51, 65, 85, 0.3);
            color: var(--text-muted);
            flex-direction: column;
            gap: 1rem;
        }

        .result-placeholder i {
            font-size: 3rem;
        }

        /* Loading animation */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Detection info */
        .detection-info {
            padding: 1.5rem;
            background: rgba(6, 214, 160, 0.05);
            border-top: 1px solid var(--border-color);
        }

        .detection-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 1rem;
            text-align: center;
        }

        .stat {
            padding: 0.5rem;
            background: rgba(99, 102, 241, 0.1);
            border-radius: 8px;
        }

        .stat-value {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--accent-color);
        }

        .stat-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        /* Live camera section */
        .live-section {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 2rem;
            text-align: center;
            margin-top: 2rem;
        }

        .camera-preview {
            width: 100%;
            max-width: 640px;
            height: 480px;
            background: black;
            border-radius: 12px;
            margin: 1rem auto;
            display: none;
            object-fit: contain;
        }

        /* Responsive design */
        @media (max-width: 768px) {
            .hero h1 {
                font-size: 2rem;
            }
            
            .hero p {
                font-size: 1rem;
            }
            
            .control-panel {
                grid-template-columns: 1fr;
            }
            
            .results-section {
                grid-template-columns: 1fr;
            }
            
            .btn-group {
                flex-direction: column;
            }
            
            .container {
                padding: 1rem;
            }
        }

        /* Accessibility */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }
    </style>
</head>
<body>
    <div class="bg-animation"></div>
    
    <!-- Header -->
    <header class="header">
        <nav class="nav">
            <div class="logo">
                <i class="fas fa-robot"></i>
                Object Detection Studio
            </div>
            <div class="status-indicator">
                <div class="status-dot"></div>
                System Online
            </div>
        </nav>
    </header>

    <!-- Main Content -->
    <main class="container">
        <!-- Hero Section -->
        <section class="hero">
            <h1>🎯 Advanced Object Detection</h1>
            <p>Upload images or use live camera feed to detect objects with state-of-the-art AI technology. Powered by YOLOv5 for real-time, accurate detection.</p>
        </section>

        <!-- Control Panel -->
        <section class="control-panel">
            <!-- Image Upload -->
            <div class="control-card">
                <div class="control-title">
                    <i class="fas fa-cloud-upload-alt"></i>
                    Image Detection
                </div>
                <div class="upload-area" onclick="document.getElementById('imageInput').click()">
                    <input type="file" id="imageInput" accept="image/*" style="display: none;">
                    <div class="upload-icon">
                        <i class="fas fa-image"></i>
                    </div>
                    <div class="upload-text">Drop your image here or click to browse</div>
                    <div class="upload-subtext">Supports JPG, PNG, WEBP up to 10MB</div>
                </div>
                <div class="btn-group">
                    <button class="btn btn-primary" id="detectBtn" disabled>
                        <i class="fas fa-search"></i>
                        Detect Objects
                    </button>
                    <button class="btn btn-secondary" id="clearBtn">
                        <i class="fas fa-trash"></i>
                        Clear
                    </button>
                </div>
            </div>

            <!-- Live Camera -->
            <div class="control-card">
                <div class="control-title">
                    <i class="fas fa-video"></i>
                    Live Camera Detection
                </div>
                <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">
                    Start real-time object detection using your webcam for live analysis.
                </p>
                <div class="btn-group">
                    <button class="btn btn-live" id="liveBtn">
                        <i class="fas fa-play"></i>
                        Start Live Detection
                    </button>
                    <button class="btn btn-danger" id="stopLiveBtn" style="display: none;">
                        <i class="fas fa-stop"></i>
                        Stop Live Feed
                    </button>
                </div>
            </div>

            <!-- System Info -->
            <div class="control-card">
                <div class="control-title">
                    <i class="fas fa-cog"></i>
                    System Information
                </div>
                <div class="detection-stats">
                    <div class="stat">
                        <div class="stat-value" id="modelStatus">Ready</div>
                        <div class="stat-label">Model Status</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value" id="detectionCount">0</div>
                        <div class="stat-label">Detections</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value" id="avgSpeed">-</div>
                        <div class="stat-label">Avg Speed</div>
                    </div>
                </div>
                <div class="btn-group" style="margin-top: 1rem;">
                    <button class="btn btn-secondary" id="healthBtn">
                        <i class="fas fa-heart"></i>
                        Health Check
                    </button>
                    <button class="btn btn-secondary" id="trainBtn">
                        <i class="fas fa-dumbbell"></i>
                        Train Model
                    </button>
                </div>
            </div>
        </section>

        <!-- Status Messages -->
        <div id="statusMessage" class="status-message"></div>

        <!-- Results Section -->
        <section class="results-section">
            <!-- Original Image -->
            <div class="result-card">
                <div class="result-header">
                    <div class="result-title">📷 Original Image</div>
                    <div class="result-subtitle">Uploaded image for analysis</div>
                </div>
                <div id="originalImageContainer">
                    <div class="result-placeholder">
                        <i class="fas fa-image"></i>
                        <span>Upload an image to get started</span>
                    </div>
                </div>
            </div>

            <!-- Detection Results -->
            <div class="result-card">
                <div class="result-header">
                    <div class="result-title">🎯 Detection Results</div>
                    <div class="result-subtitle">AI-powered object detection with bounding boxes</div>
                </div>
                <div id="resultImageContainer">
                    <div class="result-placeholder">
                        <i class="fas fa-robot"></i>
                        <span>Detection results will appear here</span>
                    </div>
                </div>
                <div id="detectionInfo" class="detection-info" style="display: none;">
                    <div class="detection-stats">
                        <div class="stat">
                            <div class="stat-value" id="objectCount">0</div>
                            <div class="stat-label">Objects Found</div>
                        </div>
                        <div class="stat">
                            <div class="stat-value" id="confidence">-</div>
                            <div class="stat-label">Avg Confidence</div>
                        </div>
                        <div class="stat">
                            <div class="stat-value" id="processTime">-</div>
                            <div class="stat-label">Process Time</div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Live Camera Section -->
        <section class="live-section" id="liveSection" style="display: none;">
            <div class="control-title" style="margin-bottom: 1rem;">
                <i class="fas fa-video"></i>
                Live Camera Feed
            </div>
            <video id="cameraPreview" class="camera-preview" autoplay muted></video>
            <div class="btn-group">
                <button class="btn btn-success" id="captureBtn">
                    <i class="fas fa-camera"></i>
                    Capture & Analyze
                </button>
                <button class="btn btn-primary" id="autoDetectBtn">
                    <i class="fas fa-play-circle"></i>
                    Auto Detect
                </button>
                <button class="btn btn-danger" id="stopAutoDetectBtn" style="display: none;">
                    <i class="fas fa-pause-circle"></i>
                    Stop Auto
                </button>
                <button class="btn btn-secondary" id="toggleCamera">
                    <i class="fas fa-sync"></i>
                    Switch Camera
                </button>
            </div>
        </section>
    </main>

    <script>
        // Global variables
        let imageData = null;
        let detectionCount = 0;
        let totalProcessTime = 0;
        let cameraStream = null;
        let availableCameras = [];
        let currentCameraIndex = 0;
        let autoDetectionInterval = null;
        let isAutoDetecting = false;
        let detectionSpeed = 1000; // Default 1 second
        let imageQuality = 0.5; // Lower quality for speed
        let isDetectionRunning = false; // Prevent overlapping requests

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
            setupEventListeners();
            checkAPIHealth();
        });

        function initializeApp() {
            console.log('🚀 Object Detection Studio initialized');
            updateStats();
        }

        function setupEventListeners() {
            // Image upload
            document.getElementById('imageInput').addEventListener('change', handleImageUpload);
            document.getElementById('detectBtn').addEventListener('click', detectObjects);
            document.getElementById('clearBtn').addEventListener('click', clearResults);
            
            // Live camera
            document.getElementById('liveBtn').addEventListener('click', startLiveDetection);
            document.getElementById('stopLiveBtn').addEventListener('click', stopLiveDetection);
            document.getElementById('captureBtn').addEventListener('click', captureAndAnalyze);
            document.getElementById('autoDetectBtn').addEventListener('click', startAutoDetection);
            document.getElementById('stopAutoDetectBtn').addEventListener('click', stopAutoDetection);
            document.getElementById('toggleCamera').addEventListener('click', switchCamera);
            
            // System controls
            document.getElementById('healthBtn').addEventListener('click', checkAPIHealth);
            document.getElementById('trainBtn').addEventListener('click', trainModel);

            // Drag and drop
            const uploadArea = document.querySelector('.upload-area');
            uploadArea.addEventListener('dragover', handleDragOver);
            uploadArea.addEventListener('dragleave', handleDragLeave);
            uploadArea.addEventListener('drop', handleDrop);
        }

        // Image handling
        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (file) {
                processImageFile(file);
            }
        }

        function processImageFile(file) {
            if (file.size > 10 * 1024 * 1024) {
                showStatus('File too large. Please select an image under 10MB.', 'error');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                imageData = e.target.result.split(',')[1]; // Remove data URL prefix
                displayOriginalImage(e.target.result);
                document.getElementById('detectBtn').disabled = false;
                showStatus('Image uploaded successfully! Click "Detect Objects" to analyze.', 'success');
            };
            reader.readAsDataURL(file);
        }

        function displayOriginalImage(src) {
            const container = document.getElementById('originalImageContainer');
            container.innerHTML = `<img src="${src}" alt="Original Image" class="result-image">`;
        }

        // Drag and drop handlers
        function handleDragOver(e) {
            e.preventDefault();
            e.currentTarget.classList.add('drag-over');
        }

        function handleDragLeave(e) {
            e.currentTarget.classList.remove('drag-over');
        }

        function handleDrop(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('drag-over');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                processImageFile(files[0]);
            }
        }

        // Object detection
        async function detectObjects() {
            if (!imageData) {
                showStatus('Please upload an image first.', 'error');
                return;
            }

            const detectBtn = document.getElementById('detectBtn');
            const originalText = detectBtn.innerHTML;
            
            try {
                // Update button state
                detectBtn.disabled = true;
                detectBtn.innerHTML = '<div class="loading"></div> Analyzing...';
                
                showStatus('🔍 AI is analyzing your image...', 'warning');
                
                const startTime = Date.now();
                
                const response = await fetch('/predict', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ image: imageData })
                });

                const data = await response.json();
                const processTime = Date.now() - startTime;
                
                if (data.error) {
                    showStatus(`❌ Detection failed: ${data.error}`, 'error');
                } else if (data.image) {
                    displayDetectionResult(data.image);
                    updateDetectionStats(processTime);
                    showStatus('✅ Object detection completed successfully!', 'success');
                } else {
                    showStatus('❌ Unexpected response format', 'error');
                }
                
            } catch (error) {
                showStatus(`❌ Network error: ${error.message}`, 'error');
            } finally {
                detectBtn.disabled = false;
                detectBtn.innerHTML = originalText;
            }
        }

        function displayDetectionResult(imageBase64) {
            const container = document.getElementById('resultImageContainer');
            container.innerHTML = `<img src="data:image/jpeg;base64,${imageBase64}" alt="Detection Result" class="result-image">`;
            
            // Show detection info
            document.getElementById('detectionInfo').style.display = 'block';
        }

        function updateDetectionStats(processTime) {
            detectionCount++;
            totalProcessTime += processTime;
            
            document.getElementById('detectionCount').textContent = detectionCount;
            document.getElementById('processTime').textContent = `${processTime}ms`;
            document.getElementById('avgSpeed').textContent = `${Math.round(totalProcessTime / detectionCount)}ms`;
        }

        // Live camera functionality
        async function startLiveDetection() {
            try {
                showStatus('📹 Starting camera...', 'warning');
                
                // Check if getUserMedia is supported
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    throw new Error('Camera access not supported in this browser');
                }
                
                // First try to get available cameras
                const devices = await navigator.mediaDevices.enumerateDevices();
                availableCameras = devices.filter(device => device.kind === 'videoinput');
                
                console.log('Available cameras:', availableCameras.map((cam, idx) => ({
                    index: idx,
                    label: cam.label || `Camera ${idx + 1}`,
                    deviceId: cam.deviceId
                })));
                
                // Try different camera constraints for third-party apps
                let constraints;
                
                if (availableCameras.length > 0) {
                    // If we have multiple cameras, try the last one (often virtual cameras are listed last)
                    const preferredDevice = availableCameras.length > 1 ? availableCameras[availableCameras.length - 1] : availableCameras[0];
                    currentCameraIndex = availableCameras.length > 1 ? availableCameras.length - 1 : 0;
                    
                    constraints = {
                        video: {
                            deviceId: { exact: preferredDevice.deviceId },
                            width: { ideal: 640, min: 320, max: 1920 },
                            height: { ideal: 480, min: 240, max: 1080 },
                            frameRate: { ideal: 30, max: 60 }
                        }
                    };
                } else {
                    // Fallback constraints
                    constraints = {
                        video: {
                            width: { ideal: 640, min: 320 },
                            height: { ideal: 480, min: 240 },
                            frameRate: { ideal: 30 }
                        }
                    };
                }
                
                try {
                    console.log('Trying camera with constraints:', constraints);
                    cameraStream = await navigator.mediaDevices.getUserMedia(constraints);
                } catch (constraintError) {
                    console.warn('Failed with specific constraints, trying fallback:', constraintError);
                    
                    // Fallback 1: Try without specific device ID
                    try {
                        const fallbackConstraints = {
                            video: {
                                width: { ideal: 640, min: 320 },
                                height: { ideal: 480, min: 240 },
                                frameRate: { ideal: 15 }
                            }
                        };
                        console.log('Trying fallback constraints:', fallbackConstraints);
                        cameraStream = await navigator.mediaDevices.getUserMedia(fallbackConstraints);
                    } catch (fallbackError) {
                        console.warn('Fallback 1 failed, trying minimal constraints:', fallbackError);
                        
                        // Fallback 2: Minimal constraints
                        const minimalConstraints = { video: true };
                        console.log('Trying minimal constraints:', minimalConstraints);
                        cameraStream = await navigator.mediaDevices.getUserMedia(minimalConstraints);
                    }
                }
                
                const video = document.getElementById('cameraPreview');
                video.srcObject = cameraStream;
                video.style.display = 'block';
                
                // Wait for video to be ready
                video.onloadedmetadata = function() {
                    video.play();
                };
                
                document.getElementById('liveSection').style.display = 'block';
                document.getElementById('liveBtn').style.display = 'none';
                document.getElementById('stopLiveBtn').style.display = 'inline-flex';
                
                showStatus('✅ Camera started successfully! You can now capture and analyze frames.', 'success');
                
            } catch (error) {
                console.error('Camera error:', error);
                let errorMessage = 'Camera access failed';
                
                if (error.name === 'NotAllowedError') {
                    errorMessage = 'Camera access denied. Please allow camera permissions and try again.';
                } else if (error.name === 'NotFoundError') {
                    errorMessage = 'No camera found. Please connect a camera and try again.';
                } else if (error.name === 'NotReadableError') {
                    errorMessage = 'Camera is being used by another application. Please close other apps using the camera.';
                } else {
                    errorMessage = `Camera error: ${error.message}`;
                }
                
                showStatus(`❌ ${errorMessage}`, 'error');
            }
        }

        function stopLiveDetection() {
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraStream = null;
            }
            
            document.getElementById('liveSection').style.display = 'none';
            document.getElementById('liveBtn').style.display = 'inline-flex';
            document.getElementById('stopLiveBtn').style.display = 'none';
            
            showStatus('📹 Camera stopped.', 'warning');
        }

        async function captureAndAnalyze() {
            if (!cameraStream) {
                showStatus('❌ Camera not active.', 'error');
                return;
            }

            try {
                const video = document.getElementById('cameraPreview');
                const canvas = document.createElement('canvas');
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                
                const ctx = canvas.getContext('2d');
                ctx.drawImage(video, 0, 0);
                
                const dataURL = canvas.toDataURL('image/jpeg', 0.8);
                imageData = dataURL.split(',')[1];
                
                displayOriginalImage(dataURL);
                await detectObjects();
                
            } catch (error) {
                showStatus(`❌ Capture error: ${error.message}`, 'error');
            }
        }

        // System functions
        async function checkAPIHealth() {
            try {
                showStatus('🔍 Checking system health...', 'warning');
                
                const response = await fetch('/health');
                const data = await response.json();
                
                document.getElementById('modelStatus').textContent = data.status === 'healthy' ? 'Online' : 'Offline';
                showStatus(`✅ System Health: ${data.message}`, 'success');
                
            } catch (error) {
                document.getElementById('modelStatus').textContent = 'Error';
                showStatus(`❌ Health check failed: ${error.message}`, 'error');
            }
        }

        async function trainModel() {
            const confirmTrain = confirm('Model training is a time-intensive process that may take several hours. Continue?');
            if (!confirmTrain) return;

            try {
                showStatus('🏋️ Starting model training... This may take several hours.', 'warning');
                
                const response = await fetch('/train');
                const data = await response.json();
                
                if (data.error) {
                    showStatus(`❌ Training failed: ${data.error}`, 'error');
                } else {
                    showStatus('✅ Model training completed successfully!', 'success');
                }
                
            } catch (error) {
                showStatus(`❌ Training error: ${error.message}`, 'error');
            }
        }

        function clearResults() {
            imageData = null;
            document.getElementById('detectBtn').disabled = true;
            document.getElementById('imageInput').value = '';
            
            // Reset image containers
            document.getElementById('originalImageContainer').innerHTML = `
                <div class="result-placeholder">
                    <i class="fas fa-image"></i>
                    <span>Upload an image to get started</span>
                </div>
            `;
            
            document.getElementById('resultImageContainer').innerHTML = `
                <div class="result-placeholder">
                    <i class="fas fa-robot"></i>
                    <span>Detection results will appear here</span>
                </div>
            `;
            
            document.getElementById('detectionInfo').style.display = 'none';
            showStatus('🗑️ Results cleared.', 'warning');
        }

        // Utility functions
        function showStatus(message, type) {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.className = `status-message status-${type}`;
            statusDiv.innerHTML = message;
            statusDiv.style.display = 'block';
            
            // Auto-hide success messages after 5 seconds
            if (type === 'success') {
                setTimeout(() => {
                    statusDiv.style.display = 'none';
                }, 5000);
            }
        }

        function updateStats() {
            // Update any periodic stats here
        }

        // Camera switching functionality
        async function switchCamera() {
            if (availableCameras.length <= 1) {
                showStatus('⚠️ Only one camera available. Cannot switch cameras.', 'warning');
                return;
            }

            if (!cameraStream) {
                showStatus('❌ No active camera stream. Please start the camera first.', 'error');
                return;
            }

            try {
                showStatus('🔄 Switching camera...', 'warning');

                // Stop current stream
                cameraStream.getTracks().forEach(track => track.stop());

                // Cycle to next camera
                currentCameraIndex = (currentCameraIndex + 1) % availableCameras.length;
                const nextCamera = availableCameras[currentCameraIndex];
                
                console.log(`Switching to camera ${currentCameraIndex + 1}: ${nextCamera.label || 'Unnamed Camera'}`);

                // Try to start new camera with fallbacks
                let constraints = {
                    video: {
                        deviceId: { exact: nextCamera.deviceId },
                        width: { ideal: 640, min: 320, max: 1920 },
                        height: { ideal: 480, min: 240, max: 1080 },
                        frameRate: { ideal: 30, max: 60 }
                    }
                };

                try {
                    cameraStream = await navigator.mediaDevices.getUserMedia(constraints);
                } catch (constraintError) {
                    console.warn('Failed with specific constraints, trying fallback for camera switch:', constraintError);
                    
                    // Fallback with looser constraints
                    const fallbackConstraints = {
                        video: {
                            deviceId: { exact: nextCamera.deviceId },
                            width: { ideal: 640 },
                            height: { ideal: 480 }
                        }
                    };
                    cameraStream = await navigator.mediaDevices.getUserMedia(fallbackConstraints);
                }

                const video = document.getElementById('cameraPreview');
                video.srcObject = cameraStream;

                // Wait for video to be ready
                video.onloadedmetadata = function() {
                    video.play();
                };

                const cameraName = nextCamera.label || `Camera ${currentCameraIndex + 1}`;
                showStatus(`✅ Switched to ${cameraName}`, 'success');

            } catch (error) {
                console.error('Camera switch error:', error);
                showStatus(`❌ Failed to switch camera: ${error.message}`, 'error');
                
                // Try to restart with original camera
                try {
                    currentCameraIndex = 0; // Reset to first camera
                    await startLiveDetection();
                } catch (restartError) {
                    showStatus('❌ Failed to restart camera. Please stop and start again.', 'error');
                }
            }
        }

        // Auto-detection functionality
        function startAutoDetection() {
            if (!cameraStream) {
                showStatus('❌ Camera not active. Please start the camera first.', 'error');
                return;
            }

            if (isAutoDetecting) {
                showStatus('⚠️ Auto-detection is already running.', 'warning');
                return;
            }

            isAutoDetecting = true;
            document.getElementById('autoDetectBtn').style.display = 'none';
            document.getElementById('stopAutoDetectBtn').style.display = 'inline-flex';
            
            showStatus(`🔄 Starting automatic detection... Running every ${detectionSpeed/1000} second(s) with optimized processing.`, 'success');
            
            // Run detection immediately
            performAutoDetection();
            
            // Then run with configured speed
            autoDetectionInterval = setInterval(performAutoDetection, detectionSpeed);
        }

        function stopAutoDetection() {
            if (!isAutoDetecting) {
                return;
            }

            isAutoDetecting = false;
            
            if (autoDetectionInterval) {
                clearInterval(autoDetectionInterval);
                autoDetectionInterval = null;
            }

            document.getElementById('autoDetectBtn').style.display = 'inline-flex';
            document.getElementById('stopAutoDetectBtn').style.display = 'none';
            
            showStatus('⏸️ Automatic detection stopped.', 'warning');
        }

        async function performAutoDetection() {
            if (!cameraStream || !isAutoDetecting || isDetectionRunning) {
                return;
            }

            isDetectionRunning = true; // Set flag to prevent overlapping requests

            try {
                const video = document.getElementById('cameraPreview');
                
                // Check if video is ready
                if (video.videoWidth === 0 || video.videoHeight === 0) {
                    console.log('Video not ready for capture, skipping this detection cycle');
                    return;
                }

                // Use smaller resolution for faster processing
                const desiredWidth = 320;
                const desiredHeight = 240;
                
                const canvas = document.createElement('canvas');
                canvas.width = desiredWidth;
                canvas.height = desiredHeight;
                
                const ctx = canvas.getContext('2d');
                // Draw video frame resized to smaller dimensions
                ctx.drawImage(video, 0, 0, desiredWidth, desiredHeight);
                
                const dataURL = canvas.toDataURL('image/jpeg', imageQuality); // Use configured quality
                const currentImageData = dataURL.split(',')[1];

                // Make detection request
                const startTime = Date.now();
                const response = await fetch('/predict', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ image: currentImageData })
                });

                const data = await response.json();
                const processTime = Date.now() - startTime;

                if (data.error) {
                    console.warn('Auto-detection failed:', data.error);
                } else if (data.image) {
                    // Update results quietly (without status messages)
                    imageData = currentImageData;
                    displayOriginalImage(dataURL);
                    displayDetectionResult(data.image);
                    updateDetectionStats(processTime);
                    
                    console.log(`Auto-detection completed in ${processTime}ms`);
                }
                
            } catch (error) {
                console.warn('Auto-detection error:', error.message);
                // Don't show error status messages during auto-detection to avoid spam
            } finally {
                isDetectionRunning = false; // Reset flag whether success or error
            }
        }

        // Clean up auto-detection when stopping live camera
        function stopLiveDetectionWithCleanup() {
            // Stop auto-detection first
            if (isAutoDetecting) {
                stopAutoDetection();
            }
            
            // Then stop the camera
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraStream = null;
            }
            
            document.getElementById('liveSection').style.display = 'none';
            document.getElementById('liveBtn').style.display = 'inline-flex';
            document.getElementById('stopLiveBtn').style.display = 'none';
            
            showStatus('📹 Camera stopped.', 'warning');
        }

        // Initialize health check on load
        setTimeout(checkAPIHealth, 1000);
    </script>
</body>
</html>
